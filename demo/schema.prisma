// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id                 String           @id @default(uuid())
  studentId          String           @unique // e.g., STU001
  name               String
  email              String           @unique
  rollNumber         String           @unique
  universityName     String
  branch             String
  enrollmentYear     Int
  expectedGraduation Int
  yearOfStudy        Int
  age                Int
  academic           AcademicRecord?
  behavioral         BehavioralRecord?
  dashboard          Dashboard?
  enrollments        Enrollment[]
  
  // NEW: Registration system relations
  coursePreferences  CoursePreference[]
  waitlistEntries    WaitlistEntry[]
  seatBookings       SeatBooking[]
}

model AcademicRecord {
  id                   String          @id @default(uuid())
  studentId            String          @unique
  student              Student         @relation(fields: [studentId], references: [id])
  academicYear         String
  totalCredits         Int
  creditsThisSemester  Int
  overallGpa           Float
  attendancePercentage Float
  subjects             SubjectRecord[]
}

model SubjectRecord {
  id               String         @id @default(uuid())
  academicRecordId String
  academicRecord   AcademicRecord @relation(fields: [academicRecordId], references: [id])
  name             String
  marks            Float
  grade            String
  attendance       Float
  teacherRemarks   String?
}

model BehavioralRecord {
  id                 String   @id @default(uuid())
  studentId          String   @unique
  student            Student  @relation(fields: [studentId], references: [id])
  participationScore Float
  disciplineScore    Float
  extracurricular    String[]
}

model Instructor {
  id              String   @id @default(uuid())
  name            String
  email           String   @unique
  department      String
  toughnessRating String
  generalRemarks  String
  courses         Course[]
}

model Course {
  id                String       @id @default(uuid())
  courseId          String       @unique // e.g., CS101
  name              String
  category          String
  difficulty        String
  prerequisites     String[]
  description       String
  skillsDeveloped   String[]
  careerPaths       String[]
  idealFor          String
  minGpaRecommended Float
  keywords          String[]
  classroomNumber   String
  schedule          Json

  instructorId String
  instructor   Instructor @relation(fields: [instructorId], references: [id])

  enrollments       Enrollment[]
  seatConfig        SeatConfig?
  
  // NEW: Registration system relations
  coursePreferences CoursePreference[]
  waitlistEntries   WaitlistEntry[]
  seatBookings      SeatBooking[]
}

// UPDATED: More detailed enrollment tracking
model Enrollment {
  id           String           @id @default(uuid())
  status       EnrollmentStatus @default(PENDING)
  courseId     String
  course       Course           @relation(fields: [courseId], references: [id])
  studentId    String
  student      Student          @relation(fields: [studentId], references: [id])
  seatNumber   String?          // e.g., "A5", "B3"
  enrolledAt   DateTime?
  droppedAt    DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@unique([courseId, studentId])
}

enum EnrollmentStatus {
  PENDING
  WAITLISTED
  ENROLLED
  DROPPED
  REJECTED
}

// Dashboard Models (unchanged)
model Dashboard {
  id                String             @id @default(uuid())
  studentId         String             @unique
  student           Student            @relation(fields: [studentId], references: [id])
  weeklyActivity    WeeklyActivity[]
  semesterProgress  SemesterProgress[]
  upcomingDeadlines Deadline[]
  achievements      Achievement[]
  recentActivity    RecentActivity[]
}

model WeeklyActivity {
  id          String    @id @default(uuid())
  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id])
  day         String
  attendance  Int
  studyHours  Int
}

model SemesterProgress {
  id          String    @id @default(uuid())
  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id])
  semester    String
  gpa         Float
  credits     Int
}

model Deadline {
  id          String    @id @default(uuid())
  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id])
  title       String
  course      String
  dueDate     DateTime
  type        String
  priority    String
}

model Achievement {
  id          String    @id @default(uuid())
  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id])
  title       String
  description String
  icon        String
  date        DateTime?
  unlocked    Boolean
}

model RecentActivity {
  id          String    @id @default(uuid())
  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id])
  action      String
  details     String
  timestamp   DateTime
}

// UPDATED: Enhanced Seat Management
model SeatConfig {
  id            String        @id @default(uuid())
  courseId      String        @unique
  course        Course        @relation(fields: [courseId], references: [id])
  totalSeats    Int
  rows          Int           @default(13)    // A-M
  seatsPerRow   Int           @default(20)    // 1-20
  bookingStatus BookingStatus @default(CLOSED)
  bookingOpensAt DateTime?
  bookingClosesAt DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  seatBookings  SeatBooking[]
}

enum BookingStatus {
  CLOSED        // Booking not yet open
  OPEN          // Manual booking allowed
  WAITLIST_ONLY // Full, only waitlist
  STARTED       // Course started, only dropout fills
  COMPLETED     // No more changes
}

// NEW: Individual seat bookings
model SeatBooking {
  id           String      @id @default(uuid())
  seatConfigId String
  seatConfig   SeatConfig  @relation(fields: [seatConfigId], references: [id])
  courseId     String
  course       Course      @relation(fields: [courseId], references: [id])
  studentId    String
  student      Student     @relation(fields: [studentId], references: [id])
  seatNumber   String      // e.g., "A5", "B12"
  row          String      // e.g., "A"
  column       Int         // e.g., 5
  bookedAt     DateTime    @default(now())
  isActive     Boolean     @default(true)

  @@unique([seatConfigId, seatNumber])
  @@unique([courseId, studentId])
  @@index([courseId])
  @@index([studentId])
}

// NEW: Student course preferences (from recommendation system)
model CoursePreference {
  id           String   @id @default(uuid())
  studentId    String
  student      Student  @relation(fields: [studentId], references: [id])
  courseId     String
  course       Course   @relation(fields: [courseId], references: [id])
  priority     Int      // 1 = highest priority
  matchReason  String?  // Why this course was recommended
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([studentId, courseId])
  @@index([studentId])
}

// NEW: Waitlist entries with scoring
model WaitlistEntry {
  id             String          @id @default(uuid())
  studentId      String
  student        Student         @relation(fields: [studentId], references: [id])
  courseId       String
  course         Course          @relation(fields: [courseId], references: [id])
  
  // Scoring components (for transparency)
  gpaScore       Float           @default(0)
  interestScore  Float           @default(0)
  timeScore      Float           @default(0)
  yearScore      Float           @default(0)
  compositeScore Float           @default(0)
  
  // Status tracking
  status         WaitlistStatus  @default(WAITING)
  position       Int?            // Current position in queue
  appliedAt      DateTime        @default(now())
  processedAt    DateTime?
  
  // Preferred seat (optional)
  preferredSeat  String?
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([studentId, courseId])
  @@index([courseId, compositeScore])
  @@index([courseId, status])
}

enum WaitlistStatus {
  WAITING     // In queue
  PROCESSING  // Being processed
  ALLOCATED   // Got a seat
  EXPIRED     // Didn't respond in time
  CANCELLED   // Student cancelled
}

// NEW: Registration events for audit trail
model RegistrationEvent {
  id          String   @id @default(uuid())
  eventType   String   // APPLIED, ALLOCATED, DROPPED, WAITLIST_MOVED, etc.
  studentId   String
  courseId    String
  seatNumber  String?
  metadata    Json?    // Additional event data
  createdAt   DateTime @default(now())

  @@index([courseId])
  @@index([studentId])
  @@index([createdAt])
}
